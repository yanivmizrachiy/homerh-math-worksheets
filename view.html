<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תצוגה בלייב - דף עבודה</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {tex: {inlineMath: [['$', '$']], displayMath: [['$$', '$$']]}};
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&family=Assistant:wght@400;600;700&display=swap');
        * {box-sizing: border-box; margin: 0; padding: 0;}
        body {
            font-family: 'Heebo', 'Assistant', 'Arial Hebrew', sans-serif;
            direction: rtl;
            background: #f0f0f0;
            padding: 20px;
        }
        .page {
            max-width: 21cm;
            margin: 0 auto;
            background: white;
            padding: 2.5cm 2cm;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            min-height: 29.7cm;
        }
        h1 {font-size: 18pt; border-bottom: 2px solid #333; padding-bottom: 0.5em; margin-bottom: 1em; color: #003366;}
        h2 {font-size: 16pt; border-bottom: 1px solid #ddd; margin-top: 1.5em; margin-bottom: 0.8em; color: #003366;}
        h3 {font-size: 15pt; margin-top: 1.5em; margin-bottom: 0.7em; color: #003366; background-color: #e0f7fa; border-right: 5px solid #007bff; padding: 5px 10px; margin-right: -10px;}
        p {text-align: justify; margin: 0.8em 0; line-height: 1.8;}
        img {max-width: 100%; height: auto; display: block; margin: 1em auto; border: 3px solid #003366; box-shadow: 5px 5px 15px rgba(0,0,0,0.3);}
        table {width: 100%; border-collapse: collapse; margin: 1em 0;}
        table th, table td {border: 1px solid #333; padding: 0.5em; text-align: right;}
        table th {background-color: #f0f0f0; font-weight: bold;}
        ul, ol {margin: 0.8em 0; padding-right: 2em;}
        li {margin: 0.3em 0;}
        code {font-family: 'Courier New', monospace; background-color: #f5f5f5; padding: 0.2em 0.4em; border-radius: 3px;}
        pre {background-color: #f5f5f5; padding: 1em; border-radius: 5px; overflow-x: auto;}
        .math-display {direction: ltr; text-align: center; margin: 1em 0; font-size: 1.1em;}
        .math-inline {direction: ltr; font-size: 1em;}
        hr {border: none; border-top: 1px solid #ddd; margin: 1.5em 0;}
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .back-link:hover {background: #0056b3;}
        .loading {text-align: center; padding: 50px; font-size: 18pt; color: #666;}
    </style>
</head>
<body>
    <a href="preview.html" class="back-link">← חזרה לרשימת דפי עבודה</a>
    <div class="page" id="content">
        <div class="loading">⏳ טוען...</div>
    </div>
    <script>
        // קבלת שם הקובץ מה-URL
        const params = new URLSearchParams(window.location.search);
        const file = params.get('file') || 'worksheets/grade-8/kavba_a1_graph_reading.md';

        // ניסיון טעינה עם fetch - נתיב יחסי לשרת
        const filePath = file.startsWith('/') ? file : '/' + file;
        console.log('Loading file:', filePath);
        fetch(filePath)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(text => {
                // הסרת front matter אם קיים
                if (text.startsWith('---')) {
                    const parts = text.split('---', 2);
                    if (parts.length >= 3) {
                        text = parts[2].trim();
                    }
                }

                console.log('File loaded, length:', text.length);
                console.log('Marked available:', typeof marked !== 'undefined');

                // המרת Markdown ל-HTML
                if (typeof marked !== 'undefined') {
                    try {
                        marked.setOptions({
                            breaks: true,
                            gfm: true
                        });

                        let html = marked.parse(text);
                        console.log('HTML generated, length:', html.length);

                        // עיבוד LaTeX math
                        html = html.replace(/\$\$([^$]+)\$\$/g, '<div class="math-display">$$$1$$</div>');
                        html = html.replace(/\$([^$]+)\$/g, '<span class="math-inline">$$$1$</span>');

                        // הצגת התוכן
                        document.getElementById('content').innerHTML = html;
                        console.log('Content displayed');

                        // עדכון MathJax אחרי טעינת התוכן
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise().then(() => {
                                console.log('MathJax rendered');
                            }).catch(err => {
                                console.error('MathJax error:', err);
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing markdown:', e);
                        document.getElementById('content').innerHTML = '<h1>שגיאה בעיבוד</h1><pre>' + e.message + '</pre><hr><pre>' + text.substring(0, 500) + '</pre>';
                    }
                } else {
                    // אם marked לא זמין, הצגת טקסט גולמי עם פורמט בסיסי
                    console.warn('marked not available, showing raw text');
                    document.getElementById('content').innerHTML = '<pre>' + text.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
                }
            })
            .catch(error => {
                console.error('Error loading file:', error);
                document.getElementById('content').innerHTML = '<h1>שגיאה</h1><p>לא ניתן לטעון את הקובץ: ' + error.message + '</p><p>אנא בדוק שהשרת רץ ועדכן את הדף.</p><p>נתיב ניסה לטעון: ' + filePath + '</p>';
            });
    </script>
</body>
</html>
